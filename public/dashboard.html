<!DOCTYPE html>
<html lang="pt-br">

<head>
    <link rel="shortcut icon" href="../assets/icon/favicon2.ico" type="image/x-icon">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./css/dashboard.css">
    <link rel="stylesheet" href="./css/estilo.css">
    <title>Dashboard</title>

    <script src="../js/sessao.js"></script>
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Exo+2&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://kit.fontawesome.com/9f7414eb10.js" crossorigin="anonymous"></script>
</head>

<body>

    <div class="janela">
        <div class="header-left">
            <h1>ACADEMIA START</h1>
            <div class="hello">
                <h3>Olá, <span id="b_usuario">usuário</span>!</h3>
            </div>
            <div class="btn-logout" onclick="limparSessao()">
                <h3>Sair</h3>
            </div>
        </div>
        <div class="dash">
            <div id="alerta"></div>
            <div class="btns-dash" id="btnPontuacao"></div>
            <div id="graficos"></div>
        </div>
    </div>

    <script>

        // Verifique se o sessionStorage.PONTUACAO existe
        let pontuacao = sessionStorage.getItem('PONTUACAO');
        if (!pontuacao) {
            pontuacao = [];
        } else {
            // Converta a string JSON de pontuação de volta para um array
            pontuacao = JSON.parse(pontuacao);
        }

        // Adicione um novo item ao array na posição desejada
        const novoItem = { idPontuacao: 1, descricao: 'Pontuação 1' }; // Substitua pelos valores desejados
        const posicaoDesejada = 0; // Substitua pela posição desejada

        // Verifique se a posição desejada está dentro do intervalo do array
        if (posicaoDesejada >= 0 && posicaoDesejada <= pontuacao.length) {
            pontuacao.splice(posicaoDesejada, 0, novoItem); // Insere o novo item na posição desejada
        } else {
            console.error('Posição desejada fora do intervalo do array');
        }

        // Atualize o sessionStorage.PONTUACAO com o array modificado
        sessionStorage.setItem('PONTUACAO', JSON.stringify(pontuacao));

        document.addEventListener("DOMContentLoaded", function () {
            const b_usuario = document.getElementById('b_usuario');

            // Log para verificar valores do sessionStorage
            console.log('NOME_USUARIO:', sessionStorage.NOME_USUARIO);
            console.log('PONTUACAO:', sessionStorage.PONTUACAO);

            if (sessionStorage.NOME_USUARIO && sessionStorage.PONTUACAO) {
                b_usuario.innerHTML = sessionStorage.NOME_USUARIO;
                exibirPontuacoes();
            } else {
                console.error("Sessão do usuário ou pontuação não definida");
            }
        });

        function exibirPontuacoes() {
            const pontuacoes = JSON.parse(sessionStorage.PONTUACAO || "[]");

            // Log para verificar o conteúdo de pontuacoes
            console.log('Pontuações:', pontuacoes);

            pontuacoes.forEach(item => {
                document.getElementById("btnPontuacao").innerHTML += `
                    <button class="btn-chart" onclick="exibirGrafico(${item.idPontuacao})" id="btnPontuacao${item.idPontuacao}">${item.descricao}</button>
                `;
                document.getElementById("graficos").innerHTML += `
                    <div id="grafico${item.idPontuacao}" class="display-none">
                        <h3 class="tituloGraficos">
                            <span id="tituloPontuacao${item.idPontuacao}">${item.descricao}</span>
                        </h3>
                        <div class="graph">
                            <canvas id="myChartCanvas${item.idPontuacao}"></canvas>
                        </div>
                        <div class="label-captura">
                            <p id="avisoCaptura${item.idPontuacao}" style="color: white"></p>
                        </div>
                    </div>
                `;

                obterDadosGrafico(item.idPontuacao);
            });

            if (pontuacoes.length > 0) {
                exibirGrafico(pontuacoes[0].idPontuacao);
            }
        }

        function exibirGrafico(idPontuacao) {
            const pontuacoes = JSON.parse(sessionStorage.PONTUACAO || "[]");

            pontuacoes.forEach(item => {
                const grafico = document.getElementById(`grafico${item.idPontuacao}`);
                const btn = document.getElementById(`btnPontuacao${item.idPontuacao}`);

                if (item.idPontuacao === idPontuacao) {
                    grafico.classList.remove("display-none");
                    grafico.classList.add("display-block");
                    btn.classList.remove("btn-white");
                    btn.classList.add("btn-pink");
                } else {
                    grafico.classList.remove("display-block");
                    grafico.classList.add("display-none");
                    btn.classList.remove("btn-pink");
                    btn.classList.add("btn-white");
                }
            });
        }

        function obterDadosGrafico(idPontuacao) {
            alterarTitulo(idPontuacao);

            if (typeof proximaAtualizacao !== 'undefined') {
                clearTimeout(proximaAtualizacao);
            }

            fetch(`/medidas/ultimas/${idPontuacao}`, { cache: 'no-store' })
                .then(response => response.ok ? response.json() : Promise.reject('Nenhum dado encontrado ou erro na API'))
                .then(resposta => {
                    resposta.reverse();
                    plotarGrafico(resposta, idPontuacao);
                })
                .catch(error => {
                    console.error(`Erro na obtenção dos dados p/ gráfico: ${error}`);
                });
        }

        function plotarGrafico(dados, idPontuacao) {
            const labels = dados.map(item => item.dtQuiz);
            const data = dados.map(item => item.pontuacaoQuiz);

            const config = {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Pontuação do Quiz',
                        data: data,
                        fill: false,
                        borderColor: 'rgb(75, 192, 192)',
                        tension: 0.1
                    }]
                }
            };

            const canvas = document.getElementById(`myChartCanvas${idPontuacao}`);
            new Chart(canvas, config);

            setTimeout(() => atualizarGrafico(idPontuacao, data, canvas), 2000);
        }

        function atualizarGrafico(idPontuacao, data, canvas) {
            fetch(`/medidas/tempo-real/${idPontuacao}`, { cache: 'no-store' })
                .then(response => response.ok ? response.json() : Promise.reject('Nenhum dado encontrado ou erro na API'))
                .then(novoRegistro => {
                    if (novoRegistro[0].dtQuiz !== data.labels[data.labels.length - 1]) {
                        data.labels.shift();
                        data.labels.push(novoRegistro[0].dtQuiz);
                        data.datasets[0].data.shift();
                        data.datasets[0].data.push(novoRegistro[0].pontuacaoQuiz);
                        canvas.update();
                    } else {
                        document.getElementById(`avisoCaptura${idPontuacao}`).innerHTML = "Sem novos dados para exibir.";
                    }
                    proximaAtualizacao = setTimeout(() => atualizarGrafico(idPontuacao, data, canvas), 2000);
                })
                .catch(error => {
                    console.error(`Erro na obtenção dos dados p/ gráfico: ${error}`);
                    proximaAtualizacao = setTimeout(() => atualizarGrafico(idPontuacao, data, canvas), 2000);
                });
        }

        function alterarTitulo(idPontuacao) {
            const titulo = document.getElementById(`tituloPontuacao${idPontuacao}`);
            const descricao = JSON.parse(sessionStorage.PONTUACAO).find(item => item.idPontuacao === idPontuacao).descricao;
            titulo.innerHTML = `Últimas medidas de pontuação do <span style='color: #e6005a'>${descricao}</span>`;
        }
    </script>
</body>

</html>