<!DOCTYPE html>
<html lang="pt-br">

<head>
    <link rel="shortcut icon" href="../assets/icon/favicon2.ico" type="image/x-icon">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DASHBOARD</title>

    <link rel="stylesheet" href="./css/dashboard.css">
    <script src="../js/sessao.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Exo+2:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900&display=swap"
        rel="stylesheet">
</head>

<body style="background-color: #161618;">
    <div class="janela">
        <div class="header-left">
            <h1>BEM-VINDO(A)</h1>
            <div class="img"><img src="./assets/logo.png" alt=""></div>
            <div class="hello">
                <h3>Olá, <span id="b_usuario">usuário</span>!</h3>
            </div>
          
            <button class="btn-voltar" onclick="quiz()">REFAZER QUIZ</button> 
            
            <div class="btn-logout" onclick="limparSessao()">
                <h3>Sair</h3>
            </div>
        </div>
        <dialog id="sair">
            <div class="modal">
                <p id="p"><span style="color: #000000">TEM CERTEZA QUE DESEJA SAIR?</span><br><br>
                </p>
            </div>
            <button class="botaoModal" style="margin-left: 3.5vw; margin-top: -8vh;" onclick="login()">SAIR</button>
            <button class="botaoModal" style="margin-top: -8vh;" onclick="fechar()">NÃO</button>

        </dialog>
        <div class="dash-right">
            <div class="avisos">
                <div class="container">
                    <div class="div-form">
                        <br>    
                        <button id="verHistorico" onclick="listar()" style="width: 20vw; margin-top: 11vh;">VER RANKING DE PONTUAÇÃO</button>
                    </div><br>
                    <div style="display: flex; flex-direction: row;">
                        <div style="margin-left: 50vw;" class="div-results">
                            <div id="feed_container" class="feed-container"></div>
                        </div>
                        <div style="height: 45vh; width: 50vw; margin-top: -10vh;">
                            <canvas id="myChart"></canvas>
                        </div>
                       
                    </div>
                    <div style="height: 40vh; width: 40vw; margin-top: 4vh; margin-bottom: 3vh;">
                        <canvas id="myLineChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function listar() {
            if (sessionStorage.NOME_USUARIO) {
                b_usuario.innerHTML = sessionStorage.NOME_USUARIO;
            } else {
                console.error("Sessão do usuário ou pontuação não definida");
            }

            fetch("/dash/listar").then(function (resposta) {
                if (resposta.ok) {
                    if (resposta.status == 204) {
                        var feed = document.getElementById("feed_container");
                        var mensagem = document.createElement("span");
                        mensagem.innerHTML = `<p style="font-weight: bold;color: #32b9cd;">NENHUM RESULTADO ENCONTRADO PARA O USUÁRIO "${sessionStorage.ID_USUARIO}"</p>`;
                        feed.appendChild(mensagem);
                        throw "Nenhum resultado encontrado!!";
                    }

                    resposta.json().then(function (resposta) {
                        console.log("Dados recebidos: ", JSON.stringify(resposta));

                        var feed = document.getElementById("feed_container");
                        feed.innerHTML = "";
                        let totalQuestions = 0;
                        let correctAnswers = 0;
                        let rounds = [];
                        let scores = [];

                        for (let i = 0; i < resposta.length; i++) {
                            var publicacao = resposta[i];
                            feed.innerHTML +=  `<p style="font-weight: lighter; font-size: 20px;  font-family: Cambria, Cochin, Georgia, Times, 'Times New Roman', serif;">
                             ${i +1}º Lugar: <b>${publicacao.nome}</b></b><br>
                             EMAIL CADASTRADO: <b>${publicacao.email}</b></b><br>
                             QUANTIDADE DE ACERTOS: <b>${publicacao.score}</b> <br>
                             QUESTÕES TOTAIS: <b>${publicacao.totalQuestions}</b> <br>
                             DATA E HORA DA RODADA: <b>${new Date(publicacao.data).toLocaleString("pt-BR")}</b><br><br></p>`;

                            correctAnswers = publicacao.score;
                            totalQuestions = publicacao.totalQuestions;
                            scores.push(publicacao.score);
                            rounds.push(i + 1); // Adiciona o número da rodada atual (i + 1) ao array rounds
                        }

                        const incorrectAnswers = totalQuestions - correctAnswers;

                        const labels = ['Erros', 'Acertos'];
                        const data = {
                            labels: labels,
                            datasets: [{
                                label: 'Pontuação:',
                                backgroundColor: ['red', '#3022cf'],
                                borderWidth: 2,
                                data: [
                                    incorrectAnswers,
                                    correctAnswers
                                ],
                            }]
                        };

                        const config = {
                            type: 'pie',
                            data: data,
                            options: {
                                plugins: {
                                    legend: {
                                        display: true,
                                        labels: {
                                            color: 'white',
                                        }
                                    },
                                    tooltip: {
                                        callbacks: {
                                            label: function (context) {
                                                let label = context.label || '';
                                                if (label) {
                                                    label += ': ';
                                                }
                                                // Adicionando a porcentagem ao tooltip
                                                label += (context.raw * 1);
                                                return label;
                                            }
                                        }
                                    }
                                }
                            }
                        };

                        const canvas = document.getElementById('myChart');
                        new Chart(canvas, config);
                    });
                } else {
                    throw ('Houve um erro na API!');
                }
            }).catch(function (resposta) {
                console.error(resposta);
            });
        }

        function quiz() {

            window.location.href = "quiz.html";
        }

        function limparSessao(){
            sair.showModal()
        }

        function login(){
            window.location.href="login.html"
        }

        function fechar(){
            sair.close()
        }
    </script>
</body>

</html>
